# 生产环境 Nginx 配置（PM2 部署场景）
# 用法：sudo cp infra/nginx/nginx.production.conf /etc/nginx/sites-available/blogs
#       sudo ln -s /etc/nginx/sites-available/blogs /etc/nginx/sites-enabled/
#       sudo nginx -t && sudo systemctl reload nginx

upstream web {
  server 127.0.0.1:3000;
}

# HTTP → HTTPS 自动跳转（需先配置 SSL 证书后取消注释）
# server {
#   listen 80;
#   server_name <你的域名>;
#   return 301 https://$server_name$request_uri;
# }

# HTTP 反向代理（无 HTTPS 时使用，访问 80 端口即访问 3000）
server {
  listen 80;
  server_name _;  # 匹配任意域名，可改为具体域名如 blog.example.com

  client_max_body_size 20M;

  # 根路径跳转到 /web/
  location = / { return 301 $scheme://$host/web/; }

  # /web 应用（保留 /web 前缀转发给 Next.js）
  location /web {
    proxy_pass http://web;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
  }
}

# HTTPS 反向代理（配置 SSL 后取消注释，并注释掉上面的 HTTP server）
# server {
#   listen 443 ssl http2;
#   server_name <你的域名>;
#
#   ssl_certificate     /etc/nginx/ssl/fullchain.pem;
#   ssl_certificate_key /etc/nginx/ssl/privkey.pem;
#
#   client_max_body_size 20M;
#
#   location / {
#     proxy_pass http://web;
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection 'upgrade';
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_cache_bypass $http_upgrade;
#   }
# }
